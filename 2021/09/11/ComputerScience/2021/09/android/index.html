<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xsdjt.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"./public/search.xml"};
  </script>

  <meta name="description" content="重新捡起嵌入式知识，回到工作轨道。">
<meta property="og:type" content="article">
<meta property="og:title" content="自下而上的了解Android">
<meta property="og:url" content="https://xsdjt.github.io/2021/09/11/ComputerScience/2021/09/android/index.html">
<meta property="og:site_name" content="随笔">
<meta property="og:description" content="重新捡起嵌入式知识，回到工作轨道。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-09-11T09:50:00.000Z">
<meta property="article:modified_time" content="2025-01-21T23:19:01.694Z">
<meta property="article:author" content="周国强">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="linux">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://xsdjt.github.io/2021/09/11/ComputerScience/2021/09/android/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>自下而上的了解Android | 随笔</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">随笔</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">记录，分享，然后享受生活。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-links">

    <a href="/links/" rel="section"><i class="fa fa-train fa-fw"></i>推荐链接</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xsdjt.github.io/2021/09/11/ComputerScience/2021/09/android/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/uparrow.jpg">
      <meta itemprop="name" content="周国强">
      <meta itemprop="description" content="勤学勤思出真知">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随笔">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          自下而上的了解Android<a href="https://github.com/xsdjt/hexo-blog/tree/main/source/_posts/ComputerScience/2021/09/android.md" class="post-edit-link" title="编辑" rel="noopener" target="_blank"><i class="fa fa-pencil-alt"></i></a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-11 09:50:00" itemprop="dateCreated datePublished" datetime="2021-09-11T09:50:00+00:00">2021-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E4%B8%8E%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">计算机科学与技术</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E4%B8%8E%E6%8A%80%E6%9C%AF/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%E4%B8%8E%E6%8A%80%E6%9C%AF/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          
            <div class="post-description">重新捡起嵌入式知识，回到工作轨道。</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>开始时间（2021年9月11日9点50分 ）<br>结束时间（2021年9月19日16点40分）<br>注意空间要留够，最好留500G空间用来存放AOSP的源代码。（笔者在第一次实验时只留了300G，结果做到最后发现实验空间不够了，临时切换到deepin系统使用gparted工具扩容到了600G以上）</p>
<p>该记录是为了自下而上的了解安卓程序运行的整个流程，参考的文档大部分都放在了本记录的参考内容之中，由于网络上的教程比较分散且部分内容和使用的源码版本不一致，故在此整理，以便日后复习使用。</p>
<h2 id="环境准备（基于ubuntu16-04）"><a href="#环境准备（基于ubuntu16-04）" class="headerlink" title="环境准备（基于ubuntu16.04）"></a>环境准备（基于ubuntu16.04）</h2><h3 id="下载Android源代码"><a href="#下载Android源代码" class="headerlink" title="下载Android源代码"></a>下载Android源代码</h3><p><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/">使用清华源下载源码</a></p>
<p>下载源码时可能需要把https换成http</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">repo init -u http://aosp.tuna.tsinghua.edu.cn/platform/manifest -b android-7.0.0_r28</span><br></pre></td></tr></table></figure>
<p>另外如果碰到python环境有问题，可以重新安装python环境，之后就能执行repo脚本了</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42353939/article/details/94609591">Python安装报错：”ModuleNotFoundError:No module named _ctypes“ 的解决方案</a></p>
<p>若担心网络不好中途断开链接，可以用一个shell脚本执行<code>repo.sh</code> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">repo sync -j8 </span><br><span class="line"></span><br><span class="line">while [ $? = 1 ]</span><br><span class="line">do</span><br><span class="line">    echo &quot;======sync failed ,re-sync again======&quot;</span><br><span class="line">    sleep 3</span><br><span class="line">    repo sync -j8 </span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="编译Android源代码"><a href="#编译Android源代码" class="headerlink" title="编译Android源代码"></a>编译Android源代码</h3><h4 id="安装openjdk-1-8"><a href="#安装openjdk-1-8" class="headerlink" title="安装openjdk 1.8"></a>安装openjdk 1.8</h4><p><a target="_blank" rel="noopener" href="https://www.linuxidc.com/Linux/2017-11/148695.htm">Ubuntu 16.04安装Java JDK</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install openjdk-8-jdk</span><br></pre></td></tr></table></figure>
<h4 id="安装依赖库"><a href="#安装依赖库" class="headerlink" title="安装依赖库"></a>安装依赖库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libx11-dev:i386 libreadline6-dev:i386 libgl1-mesa-dev</span><br><span class="line">g++-multilib git flex bison gperf build-essential libncurses5-dev:i386</span><br><span class="line">tofrodos python-markdown libxml2-utils xsltproc zlib1g-dev:i386 dpkg-dev</span><br><span class="line">libsdl1.2-dev libesd0-dev git-core gnupg flex bison gperf build-essential</span><br><span class="line">zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386</span><br><span class="line">lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev</span><br><span class="line">ccache libgl1-mesa-dev libxml2-utils xsltproc unzip m4</span><br></pre></td></tr></table></figure>
<h4 id="编译AOSP项目的源代码"><a href="#编译AOSP项目的源代码" class="headerlink" title="编译AOSP项目的源代码"></a>编译AOSP项目的源代码</h4><p>由于最后编写应用程序验证驱动时会碰到 <code>selinux</code> 的问题，在查阅了相关资料后修改 <code>system/core/init/init.cpp</code> 的一行代码，关闭安全选项 <code>SELINUX_ENFORCING</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> selinux_enforcing_status <span class="title">selinux_status_from_cmdline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//selinux_enforcing_status status = SELINUX_ENFORCING;</span></span><br><span class="line">    selinux_enforcing_status status = SELINUX_PERMISSIVE;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">import_kernel_cmdline</span>(<span class="literal">false</span>, [&amp;](<span class="keyword">const</span> std::string&amp; key, <span class="keyword">const</span> std::string&amp; value, <span class="keyword">bool</span> in_qemu) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="string">&quot;androidboot.selinux&quot;</span> &amp;&amp; value == <span class="string">&quot;permissive&quot;</span>) &#123;</span><br><span class="line">            status = SELINUX_PERMISSIVE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>开始编译源码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入AOSP项目根目录</span></span><br><span class="line">cd android</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">设置环境变量</span></span><br><span class="line">source build/envsetup.sh </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">选择平台 选择2       2.aosp_arm64-eng</span></span><br><span class="line">lunch 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行编译</span></span><br><span class="line">make -j8</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译SDK</span></span><br><span class="line">make sdk -j8</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行android启动sdk manager下载项目相关工具</span></span><br><span class="line">android</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>下载好后通过 <code>android list targets</code> 命令来查看当前系统中可以创建哪些平台的虚拟设备，在我的系统下，这条命令的执行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Available Android targets:</span><br><span class="line">----------</span><br><span class="line">id: 1 or &quot;android-24&quot;</span><br><span class="line">     Name: Android 7.0</span><br><span class="line">     Type: Platform</span><br><span class="line">     API level: 24</span><br><span class="line">     Revision: 2</span><br><span class="line">     Skins: HVGA, QVGA, WQVGA400, WQVGA432, WSVGA, WVGA800 (default), WVGA854, WXGA720, WXGA800, WXGA800-7in</span><br><span class="line"> Tag/ABIs : default/armeabi-v7a</span><br><span class="line">----------</span><br><span class="line">id: 2 or &quot;Google Inc.:Google APIs:24&quot;</span><br><span class="line">     Name: Google APIs</span><br><span class="line">     Type: Add-On</span><br><span class="line">     Vendor: Google Inc.</span><br><span class="line">     Revision: 1</span><br><span class="line">     Description: Android + Google APIs</span><br><span class="line">     Based on Android 7.0 (API level 24)</span><br><span class="line">     Libraries:</span><br><span class="line">      * com.android.future.usb.accessory (usb.jar)</span><br><span class="line">          API for USB Accessories</span><br><span class="line">      * com.google.android.media.effects (effects.jar)</span><br><span class="line">          Collection of video effects</span><br><span class="line">      * com.google.android.maps (maps.jar)</span><br><span class="line">          API for Google Maps</span><br><span class="line">     Skins: HVGA, QVGA, WQVGA400, WQVGA432, WSVGA, WVGA800 (default), WVGA854, WXGA720, WXGA800, WXGA800-7in</span><br><span class="line"> Tag/ABIs : no ABIs.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接下来创建设备并运行模拟器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">创建一个Android 7.0的虚拟设备。创建的命令如下：</span></span><br><span class="line">android create avd -n helloandroid -t 1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过 emulator -<span class="built_in">help</span> 查看说明，然后运行安卓模拟器</span> </span><br><span class="line">emulator -show-kernel -avd helloandroid -partition-size 4096 -memory 2048 -cache-size 2048</span><br></pre></td></tr></table></figure>
<p>之后运行安卓模拟器需要先设置好环境变量和平台</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">设置环境变量</span></span><br><span class="line">source build/envsetup.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">选择平台 与之前编译时的选择要相同</span></span><br><span class="line">lunch 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行安卓模拟器</span></span><br><span class="line">emulator -show-kernel -avd helloandroid -partition-size 4096 -memory 2048 -cache-size 2048</span><br></pre></td></tr></table></figure>
<h3 id="下载、编译与安装android内核源代码-linux-kernel"><a href="#下载、编译与安装android内核源代码-linux-kernel" class="headerlink" title="下载、编译与安装android内核源代码(linux kernel)"></a>下载、编译与安装android内核源代码(linux kernel)</h3><p>下载 Android kernel 代码</p>
<p>先设置代理，之后才能下载内核源码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">设置代理</span></span><br><span class="line">git config --global http.proxy  IPaddress:port</span><br><span class="line">git config --global https.proxy IPaddress:port</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">内核的下载花了点时间，执行命令后，可以去做其他事了</span></span><br><span class="line">mkdir kernel &amp;&amp; cd kernel</span><br><span class="line">git clone https://android.googlesource.com/kernel/goldfish</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">取消代理</span></span><br><span class="line">git config --global --unset http.proxy</span><br><span class="line">git config --global --unset https.proxy</span><br></pre></td></tr></table></figure>
<p>下载好后进行内核版本选择，这里可以打开模拟器去看看预编译好的内核版本，然后再进行选择，笔者这里的安卓模拟器使用的Android版本是7.0内核版本显示3.10</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 进入goldfish版本内核</span></span><br><span class="line">cd goldfish </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看有哪些分支</span></span><br><span class="line">git branch -a </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 选择与预编译一致的linux内核版本的分支</span></span><br><span class="line">git checkout remotes/origin/android-goldfish-3.10</span><br><span class="line">git branch arm-3.10</span><br><span class="line">git checkout arm-3.10</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">设置环境变量</span></span><br><span class="line">source build/envsetup.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">选择平台 与之前编译源码时的选择要相同</span></span><br><span class="line">lunch 2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用安卓项目中的编译脚本来编译内核</span></span><br><span class="line">../../prebuilts/qemu-kernel/build-kernel.sh </span><br></pre></td></tr></table></figure>
<p>或者导入环境变量再编译（后面编译驱动的时候就用这种方式）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export ARCH=arm64</span><br><span class="line">export CROSS_COMPILE=aarch64-linux-android-</span><br><span class="line"><span class="meta">#</span><span class="bash">如果无法使用make goldfish  可以直接cp arch/arm/configs/某个匹配的配置文件 .config</span></span><br><span class="line">make goldfish</span><br><span class="line">make -j8</span><br></pre></td></tr></table></figure>
<p>运行安卓模拟器（使用编译好的内核）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">设置环境变量</span></span><br><span class="line">source build/envsetup.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">选择平台</span></span><br><span class="line">lunch 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行安卓模拟器，指定编译好的文件</span></span><br><span class="line">emulator -show-kernel -avd helloandroid -kernel ../kernel/goldfish/arch/arm64/boot/Image -system ./out/target/product/generic_arm64/system.img -data ./out/target/product/generic_arm64/userdata.img -ramdisk ./out/target/product/generic_arm64/ramdisk.img</span><br></pre></td></tr></table></figure>
<h2 id="编写Linux内核驱动程序"><a href="#编写Linux内核驱动程序" class="headerlink" title="编写Linux内核驱动程序"></a>编写Linux内核驱动程序</h2><p>新编译的linux内核是3.10版本，代码变动可以在drivers目录中找例子</p>
<h3 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">从 Android kernel 根目录进入drivers,并创建相关文件夹和文件</span></span><br><span class="line">cd drivers</span><br><span class="line">mkdir hello &amp;&amp; cd hello</span><br><span class="line">touch hello.h hello.c Makefile Kconfig</span><br></pre></td></tr></table></figure>
<p>各代码文件内容如下:</p>
<h4 id="hello-h"><a href="#hello-h" class="headerlink" title="hello.h"></a>hello.h</h4><figure class="highlight c"><figcaption><span>hello.h</span><a href="/downloads/code/hello/hello.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _HELLO_Android_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _HELLO_ANDROID_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_DEVICE_NODE_NAME <span class="meta-string">&quot;hello&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_DEVICE_FILE_NAME <span class="meta-string">&quot;hello&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_DEVICE_PROC_NAME <span class="meta-string">&quot;hello&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_DEVICE_CLASS_NAME <span class="meta-string">&quot;hello&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*定义一个设备结构体,此结构体可以封装设备相关的一些信息等</span></span><br><span class="line"><span class="comment">  信号量等也可以封装在此结构中，后续的设备模块一般都</span></span><br><span class="line"><span class="comment">  应该封装一个这样的结构体，但此结构体中必须包含某些</span></span><br><span class="line"><span class="comment">  成员，对于字符设备来说，我们必须包含struct cdev cdev*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hello_android_dev</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">    <span class="keyword">int</span> val;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> <span class="title">sem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">dev</span>;</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h4 id="hello-c"><a href="#hello-c" class="headerlink" title="hello.c"></a>hello.c</h4><figure class="highlight c"><figcaption><span>hello.c</span><a href="/downloads/code/hello/hello.c">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//drivers/hello/hello.c:303:5: error: implicit declaration of function &#x27;kmalloc&#x27; [-Werror=implicit-function-declaration]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seq_file.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;hello.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//主设备和从设备号变量</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> hello_major = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> hello_minor = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设备类别和设备变量</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span>* <span class="title">hello_class</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">hello_android_dev</span>* <span class="title">hello_dev</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//访问设置属性的方法</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">hello_val_show</span><span class="params">(struct device* dev, struct device_attribute* attr, <span class="keyword">char</span>* buf)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">hello_val_store</span><span class="params">(struct device* dev, struct device_attribute* attr, <span class="keyword">const</span> <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">//定义设备属性</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">DEVICE_ATTR</span><span class="params">(val, S_IRUGO | S_IWUSR, hello_val_show, hello_val_store)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传统设备文件操作方法</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_open</span><span class="params">(struct inode* inode, struct file* filp)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_release</span><span class="params">(struct inode* inode, struct file* filp)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">hello_read</span><span class="params">(struct file* filp, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span>* f_pos)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">hello_write</span><span class="params">(struct file* filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span>* f_pos)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//设备文件操作方法表</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">hello_fops</span> =</span> </span><br><span class="line">{</span><br><span class="line">     .owner = THIS_MODULE,</span><br><span class="line">     .open = hello_open,</span><br><span class="line">     .release = hello_release,</span><br><span class="line">     .read = hello_read,</span><br><span class="line">     .write = hello_write,</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">//打开设备方法</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_open</span><span class="params">(struct inode* inode, struct file* filp)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hello_android_dev</span>* <span class="title">dev</span>;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将自定义设备结构体保存在文件指针的私有数据域中，以便访问设备时拿来用</span></span><br><span class="line">    dev = container_of(inode-&gt;i_cdev, struct hello_android_dev, dev);</span><br><span class="line">    filp-&gt;private_data = dev;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//设备文件释放时调用，空实现</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_release</span><span class="params">(struct inode* inode, struct file* filp)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取设备的寄存器val的值</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">hello_read</span><span class="params">(struct file* filp, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span>* f_pos)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">      printk(<span class="string">&quot;hello_read()\n&quot;</span>);</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">ssize_t</span> err = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hello_android_dev</span>* <span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//同步访问</span></span><br><span class="line">    <span class="keyword">if</span>(down_interruptible(&amp;(dev-&gt;sem))) </span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(count &lt; <span class="keyword">sizeof</span>(dev-&gt;val)) </span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将寄存器val的值拷贝到用户提供的缓冲区</span></span><br><span class="line">    <span class="keyword">if</span>(copy_to_user(buf, &amp;(dev-&gt;val), <span class="keyword">sizeof</span>(dev-&gt;val))) </span><br><span class="line">    {</span><br><span class="line">         err = -EFAULT;</span><br><span class="line">         <span class="keyword">goto</span> out;</span><br><span class="line">     }</span><br><span class="line"></span><br><span class="line">     err = <span class="keyword">sizeof</span>(dev-&gt;val);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    up(&amp;(dev-&gt;sem));</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//写设备寄存器的值val</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">hello_write</span><span class="params">(struct file* filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span>* f_pos)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hello_android_dev</span>* <span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line">    <span class="keyword">ssize_t</span> err = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    printk(<span class="string">&quot;hello_write()\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//同步访问</span></span><br><span class="line">    <span class="keyword">if</span>(down_interruptible(&amp;(dev-&gt;sem))) {</span><br><span class="line">        <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(count != <span class="keyword">sizeof</span>(dev-&gt;val)) {</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将用户提供的缓冲区的值写到设备寄存器去</span></span><br><span class="line">    <span class="keyword">if</span>(copy_from_user(&amp;(dev-&gt;val), buf, count)) {</span><br><span class="line">        err = -EFAULT;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    }</span><br><span class="line">    err = <span class="keyword">sizeof</span>(dev-&gt;val);</span><br><span class="line">out:</span><br><span class="line">    up(&amp;(dev-&gt;sem));</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取寄存器val的值到缓冲区的buf中，内部使用</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ssize_t</span> __hello_get_val(struct hello_android_dev* dev, <span class="keyword">char</span>* buf) </span><br><span class="line">{</span><br><span class="line">      printk(<span class="string">&quot;__hello_get_val()\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> val = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//同步访问</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> *<span class="title">p_sem</span> =</span> &amp;(dev-&gt;sem);</span><br><span class="line">    <span class="keyword">if</span>(down_interruptible(p_sem))</span><br><span class="line">    {</span><br><span class="line">          printk(<span class="string">&quot;sem is used,pls wait to free.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    val = dev-&gt;val;</span><br><span class="line">    up(p_sem);</span><br><span class="line">    </span><br><span class="line">    printk(<span class="string">&quot;get val: %d\n&quot;</span>,val);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">snprintf</span>(buf, PAGE_SIZE, <span class="string">&quot;%d\n&quot;</span>, val);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//把缓冲区buf的值写到设备寄存器val中去，内部使用</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ssize_t</span> __hello_set_val(struct hello_android_dev* dev, <span class="keyword">const</span> <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count) </span><br><span class="line">{</span><br><span class="line">      printk(<span class="string">&quot;__hello_set_val()\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> val = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将字符串转换成数字</span></span><br><span class="line">    val = simple_strtol(buf, <span class="literal">NULL</span>, <span class="number">10</span>);</span><br><span class="line">    </span><br><span class="line">    printk(<span class="string">&quot;set val: %d\n&quot;</span>,val);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//同步访问</span></span><br><span class="line">    <span class="keyword">if</span>(down_interruptible(&amp;(dev-&gt;sem)))</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">return</span> -ERESTARTSYS;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    dev-&gt;val = val;</span><br><span class="line">    up(&amp;(dev-&gt;sem));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取设备属性</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">hello_val_show</span><span class="params">(struct device* dev, struct device_attribute* attr, <span class="keyword">char</span>* buf)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">      printk(<span class="string">&quot;hello_val_show()\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hello_android_dev</span>* <span class="title">hdev</span> =</span> (struct hello_android_dev*)dev_get_drvdata(dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> __hello_get_val(hdev, buf);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//写设备属性</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">hello_val_store</span><span class="params">(struct device* dev, struct device_attribute* attr, <span class="keyword">const</span> <span class="keyword">char</span>* buf, <span class="keyword">size_t</span> count)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">      printk(<span class="string">&quot;hello_val_store()\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hello_android_dev</span>* <span class="title">hdev</span> =</span> (struct hello_android_dev*)dev_get_drvdata(dev);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> __hello_set_val(hdev, buf, count);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_proc_show</span><span class="params">(struct seq_file *m, <span class="keyword">void</span> *v)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    seq_printf(m, <span class="string">&quot;%d\n&quot;</span>, hello_dev-&gt;val);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_proc_open</span><span class="params">(struct inode *inode, struct file *filp)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> single_open(filp, hello_proc_show, <span class="literal">NULL</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取设备寄存器val的值，保存在page缓冲区中</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">hello_proc_read</span><span class="params">(<span class="keyword">char</span>* page, <span class="keyword">char</span>** start, <span class="keyword">off_t</span> off, <span class="keyword">int</span> count, <span class="keyword">int</span>* eof, <span class="keyword">void</span>* data)</span> </span></span><br><span class="line"><span class="function"></span>{    </span><br><span class="line">      printk(<span class="string">&quot;hello_proc_read()\n&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(off &gt; <span class="number">0</span>) </span><br><span class="line">    {</span><br><span class="line">        *eof = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> __hello_get_val(hello_dev, page);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//把缓冲区的值buff保存到设备寄存器val中去</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">hello_proc_write</span><span class="params">(struct file* filp, <span class="keyword">const</span> <span class="keyword">char</span> __user *buff, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span>* data)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">      printk(<span class="string">&quot;hello_proc_write()\n&quot;</span>);</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">int</span> err = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span>* page = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(len &gt; PAGE_SIZE) {</span><br><span class="line">    printk(KERN_ALERT<span class="string">&quot;The buff is too large: %lu./n&quot;</span>, len);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    page = (<span class="keyword">char</span>*)__get_free_page(GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span>(!page) {</span><br><span class="line">        printk(KERN_ALERT<span class="string">&quot;Failed to alloc page./n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先把用户提供的缓冲区值拷贝到内核缓冲区中去</span></span><br><span class="line">    <span class="keyword">if</span>(copy_from_user(page, buff, len)) {</span><br><span class="line">        printk(KERN_ALERT<span class="string">&quot;Failed to copy buff from user./n&quot;</span>);</span><br><span class="line">    err = -EFAULT;</span><br><span class="line">    <span class="keyword">goto</span> out;</span><br><span class="line">    }</span><br><span class="line">    err = __hello_set_val(hello_dev, page, len);</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">    free_page((<span class="keyword">unsigned</span> <span class="keyword">long</span>)page);</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除/proc/hello文件</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_remove_proc</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    remove_proc_entry(HELLO_DEVICE_PROC_NAME, <span class="literal">NULL</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">hello_proc_fops</span> =</span> {</span><br><span class="line">	.owner	= THIS_MODULE,</span><br><span class="line">	.open	= hello_proc_open,</span><br><span class="line">	.write	= hello_proc_write,</span><br><span class="line">	.read	= seq_read,</span><br><span class="line">	.llseek	= seq_lseek,</span><br><span class="line">	.release= single_release,</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建/proc/hello文件</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_create_proc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"><span class="comment">//    struct proc_dir_entry* entry;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    entry = create_proc_entry(HELLO_DEVICE_PROC_NAME, 0, NULL);</span></span><br><span class="line"><span class="comment">//    if(entry)</span></span><br><span class="line"><span class="comment">//    {</span></span><br><span class="line"><span class="comment">//        //entry-&gt;owner = THIS_MODULE;  entry has no &quot;owner&quot; member</span></span><br><span class="line"><span class="comment">//        entry-&gt;read_proc = hello_proc_read;</span></span><br><span class="line"><span class="comment">//        entry-&gt;write_proc = hello_proc_write;</span></span><br><span class="line"><span class="comment">//    }</span></span><br><span class="line">    proc_create(HELLO_DEVICE_PROC_NAME, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;hello_proc_fops);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化设备</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __hello_setup_dev(struct hello_android_dev* dev) </span><br><span class="line">{</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="keyword">dev_t</span> devno = MKDEV(hello_major, hello_minor);</span><br><span class="line">    </span><br><span class="line">    printk(<span class="string">&quot;__hello_setup_dev()\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(dev, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct hello_android_dev));</span><br><span class="line"></span><br><span class="line">    cdev_init(&amp;(dev-&gt;dev), &amp;hello_fops);</span><br><span class="line">    dev-&gt;dev.owner = THIS_MODULE;</span><br><span class="line">    dev-&gt;dev.ops = &amp;hello_fops;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册字符设备</span></span><br><span class="line">    err = cdev_add(&amp;(dev-&gt;dev),devno, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(err) </span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化信号量和寄存器val的值</span></span><br><span class="line">    <span class="comment">//init_MUTEX(&amp;(dev-&gt;sem));  2.6.25及以后的linux内核版本废除了init_MUTEX函数</span></span><br><span class="line">    sema_init(&amp;(dev-&gt;sem),<span class="number">1</span>);</span><br><span class="line">    dev-&gt;val = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//模块加载方法</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">hello_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">int</span> err = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">dev_t</span> dev = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span>* <span class="title">temp</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    printk(KERN_ALERT<span class="string">&quot;Initializing hello device./n&quot;</span>);</span><br><span class="line">    <span class="comment">/*动态分配主设备和从设备号*/</span>    </span><br><span class="line">    err = alloc_chrdev_region(&amp;dev, <span class="number">0</span>, <span class="number">1</span>, HELLO_DEVICE_NODE_NAME);</span><br><span class="line">    <span class="keyword">if</span>(err &lt; <span class="number">0</span>) {</span><br><span class="line">        printk(KERN_ALERT<span class="string">&quot;Failed to alloc char dev region./n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    hello_major = MAJOR(dev);</span><br><span class="line">    hello_minor = MINOR(dev);  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//分配hello设备结构体变量</span></span><br><span class="line">    hello_dev = kmalloc(<span class="keyword">sizeof</span>(struct hello_android_dev), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span>(!hello_dev) {</span><br><span class="line">        err = -ENOMEM;</span><br><span class="line">        printk(KERN_ALERT<span class="string">&quot;Failed to alloc hello_dev./n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> unregister;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化设备</span></span><br><span class="line">    err = __hello_setup_dev(hello_dev);</span><br><span class="line">    <span class="keyword">if</span>(err) {</span><br><span class="line">        printk(KERN_ALERT<span class="string">&quot;Failed to setup dev: %d./n&quot;</span>, err);</span><br><span class="line">        <span class="keyword">goto</span> cleanup;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在/sys/class/目录下创建设备类别目录hello</span></span><br><span class="line">    hello_class = class_create(THIS_MODULE, HELLO_DEVICE_CLASS_NAME);</span><br><span class="line">    <span class="keyword">if</span>(IS_ERR(hello_class)) {</span><br><span class="line">        err = PTR_ERR(hello_class);</span><br><span class="line">        printk(KERN_ALERT<span class="string">&quot;Failed to create hello class./n&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> destroy_cdev;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在/dev目录和/sys/class/hello目录下分别创建设备文件hello</span></span><br><span class="line">    temp = device_create(hello_class, <span class="literal">NULL</span>, dev, <span class="string">&quot;%s&quot;</span>, HELLO_DEVICE_FILE_NAME);</span><br><span class="line">    <span class="keyword">if</span>(IS_ERR(temp)) {</span><br><span class="line">        err = PTR_ERR(temp);</span><br><span class="line">         printk(KERN_ALERT<span class="string">&quot;Failed to create hello device.&quot;</span>);</span><br><span class="line">         <span class="keyword">goto</span> destroy_class;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在/sys/class/hello/hello目录下创建属性文件val</span></span><br><span class="line">    err = device_create_file(temp, &amp;dev_attr_val);</span><br><span class="line">    <span class="keyword">if</span>(err &lt; <span class="number">0</span>) {</span><br><span class="line">        printk(KERN_ALERT<span class="string">&quot;Failed to create attribute val.&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> destroy_device;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    dev_set_drvdata(temp, hello_dev);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建/proc/hello文件</span></span><br><span class="line">    hello_create_proc();</span><br><span class="line">    printk(KERN_ALERT<span class="string">&quot;Succedded to initialize hello device./n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">destroy_device:</span><br><span class="line">    device_destroy(hello_class, dev);</span><br><span class="line">destroy_class:</span><br><span class="line">    class_destroy(hello_class);</span><br><span class="line"></span><br><span class="line">destroy_cdev:</span><br><span class="line">    cdev_del(&amp;(hello_dev-&gt;dev));</span><br><span class="line">cleanup:</span><br><span class="line">    kfree(hello_dev);</span><br><span class="line"></span><br><span class="line">unregister:</span><br><span class="line">    unregister_chrdev_region(MKDEV(hello_major, hello_minor), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//模块卸载方法</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">dev_t</span> devno = MKDEV(hello_major, hello_minor);</span><br><span class="line"></span><br><span class="line">    printk(KERN_ALERT<span class="string">&quot;Destroy hello device./n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除/proc/hello文件</span></span><br><span class="line">    hello_remove_proc();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//销毁设备类别和设备</span></span><br><span class="line">    <span class="keyword">if</span>(hello_class) {</span><br><span class="line">        device_destroy(hello_class, MKDEV(hello_major, hello_minor));</span><br><span class="line">        class_destroy(hello_class);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除字符设备和释放设备内存</span></span><br><span class="line">    <span class="keyword">if</span>(hello_dev) {</span><br><span class="line">        cdev_del(&amp;(hello_dev-&gt;dev));</span><br><span class="line">        kfree(hello_dev);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//释放设备号</span></span><br><span class="line">    unregister_chrdev_region(devno, <span class="number">1</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;First Android Driver&quot;</span>);</span><br><span class="line"></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></figure>
<h4 id="makefile"><a href="#makefile" class="headerlink" title="makefile"></a>makefile</h4><figure class="highlight makefile"><figcaption><span>Makefile</span><a href="/downloads/code/hello/Makefile">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-<span class="variable">$(CONFIG_HELLO)</span>    += hello.o</span><br></pre></td></tr></table></figure>
<h4 id="Kconfig"><a href="#Kconfig" class="headerlink" title="Kconfig"></a>Kconfig</h4><figure class="highlight plain"><figcaption><span>Kconfig</span><a href="/downloads/code/hello/Kconfig">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config HELLO</span><br><span class="line">	tristate &quot;Frist Android Driver&quot;</span><br><span class="line">	default y</span><br><span class="line">	help</span><br><span class="line">	This is the first android driver.</span><br></pre></td></tr></table></figure>
<p>接着在 kernel/drivers/Makefile 中添加如下代码:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-<span class="variable">$(CONFIG_HELLO)</span> += hello/</span><br></pre></td></tr></table></figure>
<p>继续在 kernel/drivers/Kconfig 中添加如下代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &quot;drivers&#x2F;hello&#x2F;Kconfig&quot;</span><br></pre></td></tr></table></figure>
<p>其中配置Kconfig是为了在menuconfig中生成菜单项，如果不想在配置菜单中显示，可以直接将 <code>$(CONFIG_HELLO)</code> 替换成 <code>y</code> 将Kconfig文件删除即可，也不必在上层目录的Kconfig中添加代码。</p>
<h3 id="重新编译内核"><a href="#重新编译内核" class="headerlink" title="重新编译内核"></a>重新编译内核</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在kernel/goldfish 目录执行以下命令进行内核编译</span></span><br><span class="line">cp arch/arm/configs/ranchu_defconfig .config</span><br><span class="line"><span class="meta">#</span><span class="bash">打开内核编译配置选项 确认 Device Drivers --&gt; [*]Frist Android Driver 是开启的</span></span><br><span class="line">make menuconfig</span><br><span class="line"><span class="meta">#</span><span class="bash">执行编译</span></span><br><span class="line">make -j8</span><br></pre></td></tr></table></figure>
<p>使用编译好的内核启动模拟器，再用 <code>adb shell</code> 进入安卓模拟器的终端界面，运行以下命令进行验证</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行安卓模拟器，指定编译好的文件</span></span><br><span class="line">emulator -show-kernel -avd helloandroid -kernel ../kernel/goldfish/arch/arm64/boot/Image -system ./out/target/product/generic_arm64/system.img -data ./out/target/product/generic_arm64/userdata.img -ramdisk ./out/target/product/generic_arm64/ramdisk.img</span><br></pre></td></tr></table></figure>
<p>这个时候也可以直接在执行模拟器命令的终端上按回车键即可输入命令进行驱动的验证。</p>
<p>下面是使用 <code>adb shell</code> 的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">nicho@PC:~&#x2F;work&#x2F;android$ adb shell</span><br><span class="line">generic_arm64:&#x2F; # cd dev                                                             </span><br><span class="line">generic_arm64:&#x2F;dev # ls hello                                                        </span><br><span class="line">hello</span><br><span class="line">generic_arm64:&#x2F;dev # cd &#x2F;proc                                                        </span><br><span class="line">generic_arm64:&#x2F;proc # ls hello                                                       </span><br><span class="line">hello</span><br><span class="line">generic_arm64:&#x2F;proc # cat hello                                                      </span><br><span class="line">0</span><br><span class="line">generic_arm64:&#x2F;proc # echo 9 &gt; hello                                               </span><br><span class="line">generic_arm64:&#x2F;proc # cat hello                                                      </span><br><span class="line">9</span><br><span class="line">generic_arm64:&#x2F;proc # cd &#x2F;sys&#x2F;class&#x2F;hello&#x2F;hello&#x2F;                                                                                         </span><br><span class="line">generic_arm64:&#x2F;sys&#x2F;class&#x2F;hello&#x2F;hello # cat val                                       </span><br><span class="line">9</span><br><span class="line">generic_arm64:&#x2F;sys&#x2F;class&#x2F;hello&#x2F;hello # echo 0 &gt; val                                </span><br><span class="line">generic_arm64:&#x2F;sys&#x2F;class&#x2F;hello&#x2F;hello # cat val                                       </span><br><span class="line">0</span><br></pre></td></tr></table></figure>
<h2 id="编写C可执行程序测试Linux内核驱动程序"><a href="#编写C可执行程序测试Linux内核驱动程序" class="headerlink" title="编写C可执行程序测试Linux内核驱动程序"></a>编写C可执行程序测试Linux内核驱动程序</h2><h3 id="编写代码-1"><a href="#编写代码-1" class="headerlink" title="编写代码"></a>编写代码</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">从 AOSP 根目录进入external,并创建相关文件夹和文件</span></span><br><span class="line">cd external</span><br><span class="line">mkdir hello &amp;&amp; cd hello</span><br><span class="line">touch hello.c Android.mk</span><br></pre></td></tr></table></figure>
<p>各文件代码内容如下:</p>
<h4 id="hello-c-1"><a href="#hello-c-1" class="headerlink" title="hello.c"></a>hello.c</h4><figure class="highlight c"><figcaption><span>hello.c</span><a href="/downloads/code/hello-external/hello.c">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">&quot;/dev/hello&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">int</span> val = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	fd = open(DEVICE_NAME, O_RDWR);</span><br><span class="line">	<span class="keyword">if</span>(fd == <span class="number">-1</span>)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Failed to open device %s.\n&quot;</span>, DEVICE_NAME);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;read original value:\n&quot;</span>);</span><br><span class="line">	read(fd, &amp;val, <span class="keyword">sizeof</span>(val));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d.\n\n&quot;</span>, val);</span><br><span class="line">	</span><br><span class="line">	val = <span class="number">5</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Write value %d to %s.\n\n&quot;</span>, val, DEVICE_NAME);</span><br><span class="line">	write(fd, &amp;val, <span class="keyword">sizeof</span>(val));</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Read the value again:\n&quot;</span>);</span><br><span class="line">	read(fd, &amp;val, <span class="keyword">sizeof</span>(val));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d.\n\n&quot;</span>,val);</span><br><span class="line">	</span><br><span class="line">	close(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="Android-mk"><a href="#Android-mk" class="headerlink" title="Android.mk"></a>Android.mk</h4><figure class="highlight text"><figcaption><span>Android.mk</span><a href="/downloads/code/hello-external/Android.mk">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := $(call my-dir)</span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line">LOCAL_MODULE := hello</span><br><span class="line">LOCAL_SRC_FILES := $(call all-subdir-c-files)</span><br><span class="line">include $(BUILD_EXECUTABLE)</span><br></pre></td></tr></table></figure>
<h3 id="编译hello程序"><a href="#编译hello程序" class="headerlink" title="编译hello程序"></a>编译hello程序</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">在AOSP根目录执行以下命令进行编译</span></span><br><span class="line">mmm ./external/hello</span><br><span class="line"><span class="meta">#</span><span class="bash">重新生成system.bin文件</span></span><br><span class="line">make snod</span><br></pre></td></tr></table></figure>
<p>最后重新启动模拟器即可直接在 <code>adb shell</code> 中执行 <code>hello</code> 命令验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nicho@PC:~&#x2F;work&#x2F;android$ adb shell</span><br><span class="line">generic_arm64:&#x2F; # hello                                                              </span><br><span class="line">read original value:</span><br><span class="line">0.</span><br><span class="line"></span><br><span class="line">Write value 5 to &#x2F;dev&#x2F;hello.</span><br><span class="line"></span><br><span class="line">Read the value again:</span><br><span class="line">5.</span><br></pre></td></tr></table></figure>
<h2 id="增加硬件抽象层（HAL）模块访问Linux内核驱动程序"><a href="#增加硬件抽象层（HAL）模块访问Linux内核驱动程序" class="headerlink" title="增加硬件抽象层（HAL）模块访问Linux内核驱动程序"></a>增加硬件抽象层（HAL）模块访问Linux内核驱动程序</h2><h3 id="在-android-hardware-libhardware-include-hardware-目录中创建-hello-h-文件。"><a href="#在-android-hardware-libhardware-include-hardware-目录中创建-hello-h-文件。" class="headerlink" title="在 android/hardware/libhardware/include/hardware 目录中创建 hello.h 文件。"></a>在 <code>android/hardware/libhardware/include/hardware</code> 目录中创建 <code>hello.h</code> 文件。</h3><p>内容如下</p>
<figure class="highlight c"><figcaption><span>hello.h</span><a href="/downloads/code/hello-hal/hello.h">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> Android_HELLO_INTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ANDROID_HELLO_INTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hardware/hardware.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__BEGIN_DECLS</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_HARDWARE_MODULE_ID <span class="meta-string">&quot;hello&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hello_module_t</span> {</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_t</span> <span class="title">common</span>;</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hello_device_t</span> {</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hw_device_t</span> <span class="title">common</span>;</span></span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">int</span> (*set_val)(struct <span class="keyword">hello_device_t</span>* dev, <span class="keyword">int</span> val);</span><br><span class="line">    <span class="keyword">int</span> (*get_val)(struct <span class="keyword">hello_device_t</span>* dev, <span class="keyword">int</span>* val);</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line">__END_DECLS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这里按照Android硬件抽象层规范的要求，分别定义模块ID、模块结构体以及硬件接口结构体。在硬件接口结构体中，fd表示设备文件描述符，对应我们将要处理的设备文件”/dev/hello”，set_val和get_val为该HAL对上提供的函数接口。</p>
<h3 id="在-android-hardware-libhardware-modules-hello-目录中创建-hello-c-和-Android-mk-文件。"><a href="#在-android-hardware-libhardware-modules-hello-目录中创建-hello-c-和-Android-mk-文件。" class="headerlink" title="在 android/hardware/libhardware/modules/hello 目录中创建 hello.c 和 Android.mk 文件。"></a>在 <code>android/hardware/libhardware/modules/hello</code> 目录中创建 <code>hello.c</code> 和 <code>Android.mk</code> 文件。</h3><p><code>hello</code> 目录需要手动创建</p>
<p>各文件内容如下</p>
<figure class="highlight c"><figcaption><span>hello.c</span><a href="/downloads/code/hello-hal/hello.c">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hardware/hardware.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hardware/hello.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cutils/atomic.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR,<span class="meta-string">&quot;hello_stub&quot;</span>,__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO,<span class="meta-string">&quot;hello_stub&quot;</span>,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_TAG <span class="meta-string">&quot;HelloStub&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">&quot;/dev/hello&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODULE_NAME <span class="meta-string">&quot;hello&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODULE_AUTHOR <span class="meta-string">&quot;y041039@gmail.com&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*设备打开和关闭接口*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_device_open</span><span class="params">(<span class="keyword">const</span> struct <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>, <span class="keyword">const</span> <span class="keyword">char</span>* name, struct <span class="keyword">hw_device_t</span>** device)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_device_close</span><span class="params">(struct <span class="keyword">hw_device_t</span>* device)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*设备访问接口*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_set_val</span><span class="params">(struct <span class="keyword">hello_device_t</span>* dev, <span class="keyword">int</span> val)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_get_val</span><span class="params">(struct <span class="keyword">hello_device_t</span>* dev, <span class="keyword">int</span>* val)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*模块方法表*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">hw_module_methods_t</span> <span class="title">hello_module_methods</span> =</span> {</span><br><span class="line"> open: hello_device_open</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/*模块实例变量*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hello_module_t</span> <span class="title">HAL_MODULE_INFO_SYM</span> =</span> {</span><br><span class="line"> common: {</span><br><span class="line"> tag: HARDWARE_MODULE_TAG,</span><br><span class="line"> version_major: <span class="number">1</span>,</span><br><span class="line"> version_minor: <span class="number">0</span>,</span><br><span class="line"> id: HELLO_HARDWARE_MODULE_ID,</span><br><span class="line"> name: MODULE_NAME,</span><br><span class="line"> author: MODULE_AUTHOR,</span><br><span class="line"> methods: &amp;hello_module_methods,</span><br><span class="line">}</span><br><span class="line">};</span><br><span class="line"><span class="comment">/* 这里，实例变量名必须为HAL_MODULE_INFO_SYM，tag 也必须为HARDWARE_MODULE_TAG，</span></span><br><span class="line"><span class="comment">这是Android 硬件抽象层规范规定的 */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_device_open</span><span class="params">(<span class="keyword">const</span> struct <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>, <span class="keyword">const</span> <span class="keyword">char</span>* name, struct <span class="keyword">hw_device_t</span>** device)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hello_device_t</span>* <span class="title">dev</span>;</span>dev = (struct <span class="keyword">hello_device_t</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct <span class="keyword">hello_device_t</span>));</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span>(!dev) </span><br><span class="line">      {</span><br><span class="line">        LOGE(<span class="string">&quot;Hello Stub: failed to alloc space&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">      }</span><br><span class="line">    </span><br><span class="line">      <span class="built_in">memset</span>(dev, <span class="number">0</span>, <span class="keyword">sizeof</span>(struct <span class="keyword">hello_device_t</span>));</span><br><span class="line">      dev-&gt;common.tag = HARDWARE_DEVICE_TAG;</span><br><span class="line">      dev-&gt;common.version = <span class="number">0</span>;</span><br><span class="line">      dev-&gt;common.<span class="keyword">module</span> = (<span class="keyword">hw_module_t</span>*)<span class="keyword">module</span>;</span><br><span class="line">      dev-&gt;common.close = hello_device_close;</span><br><span class="line">      dev-&gt;set_val = hello_set_val;dev-&gt;get_val = hello_get_val;</span><br><span class="line">    </span><br><span class="line">      <span class="keyword">if</span>((dev-&gt;fd = open(DEVICE_NAME, O_RDWR)) == <span class="number">-1</span>) {</span><br><span class="line">        LOGE(<span class="string">&quot;Hello Stub: failed to open /dev/hello -- %s.&quot;</span>, strerror(errno));<span class="built_in">free</span>(dev);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">      }</span><br><span class="line">     </span><br><span class="line">      *device = &amp;(dev-&gt;common);</span><br><span class="line">      LOGI(<span class="string">&quot;Hello Stub: open /dev/hello successfully.&quot;</span>);</span><br><span class="line">     </span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">DEVICE_NAME 定义为&quot;/dev/hello&quot;。由于设备文件是在内核驱动里面通过device_create 创建的，而device_create 创建的设备文</span></span><br><span class="line"><span class="comment">件默认只有root 用户可读写，而hello_device_open 一般是由上层APP 来调用的，这些APP 一般不具有root 权限，这时候就</span></span><br><span class="line"><span class="comment">导致打开设备文件失败：</span></span><br><span class="line"><span class="comment">Hello Stub: failed to open /dev/hello -- Permission denied.</span></span><br><span class="line"><span class="comment">解决办法是类似于Linux 的udev 规则，打开Android 源代码工程目录下，进入到system/core/rootdir 目录，里面有一个名为</span></span><br><span class="line"><span class="comment">uevent.rc 文件，往里面添加一行：</span></span><br><span class="line"><span class="comment">/dev/hello 0666 root root</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_device_close</span><span class="params">(struct <span class="keyword">hw_device_t</span>* device)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hello_device_t</span>* <span class="title">hello_device</span> =</span> (struct <span class="keyword">hello_device_t</span>*)device;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(hello_device)</span><br><span class="line">    {</span><br><span class="line">        close(hello_device-&gt;fd);</span><br><span class="line">        <span class="built_in">free</span>(hello_device);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_set_val</span><span class="params">(struct <span class="keyword">hello_device_t</span>* dev, <span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    LOGI(<span class="string">&quot;Hello Stub: set value %d to device.&quot;</span>, val);</span><br><span class="line"></span><br><span class="line">    write(dev-&gt;fd, &amp;val, <span class="keyword">sizeof</span>(val));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hello_get_val</span><span class="params">(struct <span class="keyword">hello_device_t</span>* dev, <span class="keyword">int</span>* val)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span>(!val)</span><br><span class="line">    {</span><br><span class="line">        LOGE(<span class="string">&quot;Hello Stub: error val pointer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    read(dev-&gt;fd, val, <span class="keyword">sizeof</span>(*val));</span><br><span class="line"></span><br><span class="line">    LOGI(<span class="string">&quot;Hello Stub: get value %d from device&quot;</span>, *val);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight makefile"><figcaption><span>Android.mk</span><a href="/downloads/code/hello-hal/Android.mk">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line"></span><br><span class="line">LOCAL_LDLIBS := -llog</span><br><span class="line"></span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line">LOCAL_PRELINK_MODULE := false</span><br><span class="line">LOCAL_MODULE_RELATIVE_PATH := hw</span><br><span class="line">LOCAL_SHARED_LIBRARIES := liblog</span><br><span class="line">LOCAL_SRC_FILES := hello.c</span><br><span class="line">LOCAL_MODULE := hello.default</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_SHARED_LIBRARY)</span></span><br></pre></td></tr></table></figure>
<p>最后记得在 <code>android/system/core/rootdir/uevent.rc</code> 文件中添加一行，使应用程序有权限访问设备节点</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/hello 0666 root root</span><br></pre></td></tr></table></figure>
<p>开始编译并重新打包系统镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">回到源码根目录执行</span></span><br><span class="line">mmm hardware/libhardware/moudles/hello</span><br><span class="line">make snod</span><br></pre></td></tr></table></figure>
<p>可以在 <code>out/target/product/generic_arm64/system/lib/hw/</code> 目录中看到有 <code>hello.default.so</code> 生成。这时的 <code>system.img</code> 就包含我们定义的硬件抽象层模块 <code>hello.default</code> 了。虽然我们在Android系统为我们自己的硬件增加了一个硬件抽象层模块，但是现在Java应用程序还不能访问到我们的硬件。还必须编写JNI方法和在Android的Application Frameworks层增加API接口，才能让上层Application访问到硬件。</p>
<h2 id="编写JNI-方法在应用程序框架层提供Java-接口访问硬件"><a href="#编写JNI-方法在应用程序框架层提供Java-接口访问硬件" class="headerlink" title="编写JNI 方法在应用程序框架层提供Java 接口访问硬件"></a>编写JNI 方法在应用程序框架层提供Java 接口访问硬件</h2><h3 id="进入-android-frameworks-base-services-core-jni-目录创建-com-android-server-HelloService-cpp-文件"><a href="#进入-android-frameworks-base-services-core-jni-目录创建-com-android-server-HelloService-cpp-文件" class="headerlink" title="进入 android/frameworks/base/services/core/jni 目录创建 com_android_server_HelloService.cpp 文件"></a>进入 <code>android/frameworks/base/services/core/jni</code> 目录创建 <code>com_android_server_HelloService.cpp</code> 文件</h3><p>在com_android_server_HelloService.cpp文件中，实现JNI方法。注意文件的命令方法，com_android_server前缀表示的是包名，表示硬件服务HelloService是放在frameworks/base/services/java目录下的com/android/server目录的，即存在一个命令为com.android.server.HelloService的类。这里，我们暂时略去HelloService类的描述，在下一篇文章中，我们将回到HelloService类来。简单地说，HelloService是一个提供Java接口的硬件访问服务类。内容如下</p>
<figure class="highlight cpp"><figcaption><span>com_android_server_HelloService.cpp</span><a href="/downloads/code/hello-jni/com_android_server_HelloService.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;jni.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;JNIHelp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android_runtime/AndroidRuntime.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/misc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utils/Log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hardware/hardware.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hardware/hello.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;android/log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGE(...) __android_log_print(ANDROID_LOG_ERROR,<span class="meta-string">&quot;hello_stub&quot;</span>,__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOGI(...) __android_log_print(ANDROID_LOG_INFO,<span class="meta-string">&quot;hello_stub&quot;</span>,__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#define LOG_TAG &quot;HelloService&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> android</span><br><span class="line">{</span><br><span class="line">    <span class="comment">/*在硬件抽象层中定义的硬件访问结构体，参考&lt;hardware/hello.h&gt;*/</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hello_device_t</span>* <span class="title">hello_device</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">/*通过硬件抽象层定义的硬件访问接口设置硬件寄存器val 的值*/</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_setVal</span><span class="params">(JNIEnv* env, jobject clazz, jint value)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">int</span> val = value;</span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;Hello JNI: set value %d to device.&quot;</span>, val);</span><br><span class="line">        <span class="keyword">if</span>(!hello_device)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">LOGI</span>(<span class="string">&quot;Hello JNI: device is not open.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        hello_device-&gt;<span class="built_in">set_val</span>(hello_device, val);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*通过硬件抽象层定义的硬件访问接口读取硬件寄存器val 的值*/</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> jint <span class="title">hello_getVal</span><span class="params">(JNIEnv* env, jobject clazz)</span> </span>{</span><br><span class="line">            <span class="keyword">int</span> val = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span>(!hello_device)</span><br><span class="line">            {</span><br><span class="line">                <span class="built_in">LOGI</span>(<span class="string">&quot;Hello JNI: device is not open.&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> val;</span><br><span class="line">            }</span><br><span class="line">            hello_device-&gt;<span class="built_in">get_val</span>(hello_device, &amp;val);</span><br><span class="line">        </span><br><span class="line">            <span class="built_in">LOGI</span>(<span class="string">&quot;Hello JNI: get value %d from device.&quot;</span>, val);</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*通过硬件抽象层定义的硬件模块打开接口打开硬件设备*/</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">hello_device_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">hw_module_t</span>* <span class="keyword">module</span>, struct <span class="keyword">hello_device_t</span>** device)</span> </span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">module</span>-&gt;methods-&gt;<span class="built_in">open</span>(<span class="keyword">module</span>, HELLO_HARDWARE_MODULE_ID, (struct <span class="keyword">hw_device_t</span>**)device);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*通过硬件模块ID 来加载指定的硬件抽象层模块并打开硬件*/</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> jboolean <span class="title">hello_init</span><span class="params">(JNIEnv* env, jclass clazz)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">hello_module_t</span>* <span class="keyword">module</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;Hello JNI: initializing......&quot;</span>);</span><br><span class="line">           </span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">hw_get_module</span>(HELLO_HARDWARE_MODULE_ID, (<span class="keyword">const</span> struct <span class="keyword">hw_module_t</span>**)&amp;<span class="keyword">module</span>) == <span class="number">0</span>) </span><br><span class="line">            {</span><br><span class="line">                <span class="built_in">LOGI</span>(<span class="string">&quot;Hello JNI: hello Stub found.&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">hello_device_open</span>(&amp;(<span class="keyword">module</span>-&gt;common), &amp;hello_device) == <span class="number">0</span>)</span><br><span class="line">                {</span><br><span class="line">                    <span class="built_in">LOGI</span>(<span class="string">&quot;Hello JNI: hello device is open.&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                }</span><br><span class="line">        </span><br><span class="line">                <span class="built_in">LOGE</span>(<span class="string">&quot;Hello JNI: failed to open hello device.&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="built_in">LOGE</span>(<span class="string">&quot;Hello JNI: failed to get hello stub module.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">          <span class="comment">/*JNI 方法表*/</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod method_table[] = </span><br><span class="line">        {</span><br><span class="line">            {<span class="string">&quot;init_native&quot;</span>, <span class="string">&quot;()Z&quot;</span>, (<span class="keyword">void</span>*)hello_init},</span><br><span class="line">            {<span class="string">&quot;setVal_native&quot;</span>, <span class="string">&quot;(I)V&quot;</span>, (<span class="keyword">void</span>*)hello_setVal},</span><br><span class="line">            {<span class="string">&quot;getVal_native&quot;</span>, <span class="string">&quot;()I&quot;</span>, (<span class="keyword">void</span>*)hello_getVal},</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">       <span class="comment">/*注册JNI 方法*/</span></span><br><span class="line">       <span class="function"><span class="keyword">int</span> <span class="title">register_android_server_HelloService</span><span class="params">(JNIEnv *env)</span></span></span><br><span class="line"><span class="function">       </span>{</span><br><span class="line">           <span class="keyword">return</span> <span class="built_in">jniRegisterNativeMethods</span>(env, <span class="string">&quot;com/android/server/HelloService&quot;</span>, method_table, <span class="built_in">NELEM</span>(method_table));</span><br><span class="line">       }</span><br><span class="line">   </span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>修改同目录的 <code>onload.cpp</code> 文件</p>
<figure class="highlight cpp"><figcaption><span>onload.cpp</span><a href="/downloads/code/hello-jni/onload.cpp">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;JNIHelp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;jni.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;utils/Log.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;utils/misc.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> android {</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_HelloService</span><span class="params">(JNIEnv* env)</span></span>; <span class="comment">//新增加的一行</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_ActivityManagerService</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_AlarmManagerService</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_AssetAtlasService</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_BatteryStatsService</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_ConsumerIrService</span><span class="params">(JNIEnv *env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_InputApplicationHandle</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_InputWindowHandle</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_InputManager</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_LightsService</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_PowerManagerService</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_SerialService</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_SystemServer</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_UsbDeviceManager</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_UsbMidiDevice</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_UsbHostManager</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_vr_VrManagerService</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_VibratorService</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_location_GnssLocationProvider</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_location_FlpHardwareProvider</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_connectivity_Vpn</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_hdmi_HdmiCecController</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_tv_TvUinputBridge</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_tv_TvInputHal</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_PersistentDataBlockService</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_Watchdog</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_server_HardwarePropertiesManagerService</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> android;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span>* <span class="comment">/* reserved */</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    JNIEnv* env = <span class="literal">NULL</span>;</span><br><span class="line">    jint result = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vm-&gt;<span class="built_in">GetEnv</span>((<span class="keyword">void</span>**) &amp;env, JNI_VERSION_1_4) != JNI_OK) {</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">&quot;GetEnv failed!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">ALOG_ASSERT</span>(env, <span class="string">&quot;Could not retrieve the env!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">register_android_server_HelloService</span>(env); <span class="comment">//新增加的一行</span></span><br><span class="line">    <span class="built_in">register_android_server_ActivityManagerService</span>(env);</span><br><span class="line">    <span class="built_in">register_android_server_PowerManagerService</span>(env);</span><br><span class="line">    <span class="built_in">register_android_server_SerialService</span>(env);</span><br><span class="line">    <span class="built_in">register_android_server_InputApplicationHandle</span>(env);</span><br><span class="line">    <span class="built_in">register_android_server_InputWindowHandle</span>(env);</span><br></pre></td></tr></table></figure>
<p>修改同目录下的 <code>Android.mk</code> 文件</p>
<figure class="highlight makefile"><figcaption><span>Android.mk</span><a href="/downloads/code/hello-jni/Android.mk">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(ENABLE_CPUSETS)</span>,)</span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(ENABLE_SCHED_BOOST)</span>,)</span><br><span class="line">LOCAL_CFLAGS += -DUSE_SCHED_BOOST</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line">LOCAL_SRC_FILES += \</span><br><span class="line">    <span class="variable">$(LOCAL_REL_DIR)</span>/com_android_server_HelloService.cpp \  <span class="comment">#新添加的一行</span></span><br><span class="line">    <span class="variable">$(LOCAL_REL_DIR)</span>/com_android_server_AlarmManagerService.cpp \</span><br><span class="line">    <span class="variable">$(LOCAL_REL_DIR)</span>/com_android_server_am_BatteryStatsService.cpp \</span><br><span class="line">    <span class="variable">$(LOCAL_REL_DIR)</span>/com_android_server_am_ActivityManagerService.cpp \</span><br><span class="line">    <span class="variable">$(LOCAL_REL_DIR)</span>/com_android_server_AssetAtlasService.cpp \</span><br><span class="line">    <span class="variable">$(LOCAL_REL_DIR)</span>/com_android_server_connectivity_Vpn.cpp \</span><br></pre></td></tr></table></figure>
<h3 id="开始编译并重新打包系统镜像"><a href="#开始编译并重新打包系统镜像" class="headerlink" title="开始编译并重新打包系统镜像"></a>开始编译并重新打包系统镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">回到源码根目录执行</span></span><br><span class="line">mmm frameworks/base/services/core/jni</span><br><span class="line">make snod</span><br></pre></td></tr></table></figure>
<p>这样，重新打包的system.img镜像文件就包含刚才编写的JNI方法，也就是可以通过Android系统的Application Frameworks层提供的硬件服务HelloService来调用这些JNI方法，进而调用低层的硬件抽象层接口去访问硬件。</p>
<h2 id="在应用程序框架层增加硬件服务接口"><a href="#在应用程序框架层增加硬件服务接口" class="headerlink" title="在应用程序框架层增加硬件服务接口"></a>在应用程序框架层增加硬件服务接口</h2><h3 id="首先定义通信接口"><a href="#首先定义通信接口" class="headerlink" title="首先定义通信接口"></a>首先定义通信接口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nicho@PC:~/work/android$ cd frameworks/base/core/java/android/os/</span><br><span class="line">nicho@PC:~/work/android/frameworks/base/core/java/android/os$ vi IHelloService.aidl </span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>IHelloService.aidl</span><a href="/downloads/code/hello-hard/IHelloService.aidl">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">package android.os;</span><br><span class="line"></span><br><span class="line">interface IHelloService </span><br><span class="line">{</span><br><span class="line">    void setVal(int val);</span><br><span class="line">    int getVal();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>修改 <code>frameworks/base目录，打开Android.mk文件，修改LOCAL_SRC_FILES变量的值，增加IHelloService.aidl源文件</code> </p>
<figure class="highlight makefile"><figcaption><span>Android.mk</span><a href="/downloads/code/hello-hard/Android.mk">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## READ ME: ########################################################</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## When updating this list of aidl files, consider if that aidl is</span></span><br><span class="line"><span class="comment">## part of the SDK API.  If it is, also add it to the list below that</span></span><br><span class="line"><span class="comment">## is preprocessed and distributed with the SDK.  This list should</span></span><br><span class="line"><span class="comment">## not contain any aidl files for parcelables, but the one below should</span></span><br><span class="line"><span class="comment">## if you intend for 3rd parties to be able to send those objects</span></span><br><span class="line"><span class="comment">## across process boundaries.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## READ ME: ########################################################</span></span><br><span class="line">LOCAL_SRC_FILES += \</span><br><span class="line">	core/java/android/accessibilityservice/IAccessibilityServiceConnection.aidl \</span><br><span class="line">	core/java/android/accessibilityservice/IAccessibilityServiceClient.aidl \</span><br><span class="line">	core/java/android/accounts/IAccountManager.aidl \</span><br></pre></td></tr></table></figure>
<figure class="highlight makefile"><figcaption><span>Android.mk</span><a href="/downloads/code/hello-hard/Android.mk">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">core/java/android/os/IUserManager.aidl \</span><br><span class="line">	core/java/android/os/IVibratorService.aidl \</span><br><span class="line">	core/java/android/os/IHelloService.aidl \  <span class="comment"># 添加的一行</span></span><br></pre></td></tr></table></figure>
<h3 id="编译IHelloService-aidl接口"><a href="#编译IHelloService-aidl接口" class="headerlink" title="编译IHelloService.aidl接口"></a>编译IHelloService.aidl接口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nicho@PC:~/work/android$ mmm frameworks/base/</span><br></pre></td></tr></table></figure>
<p>这样，就会根据IHelloService.aidl生成相应的IHelloService.Stub接口。</p>
<p>接下来在 <code>frameworks/base/services/java/com/android/server</code> 目录中添加 <code>HelloService.java</code> 文件</p>
<figure class="highlight java"><figcaption><span>HelloService.java</span><a href="/downloads/code/hello-hard/HelloService.java">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.android.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.IHelloService;</span><br><span class="line"><span class="keyword">import</span> android.util.Slog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloService</span> <span class="keyword">extends</span> <span class="title">IHelloService</span>.<span class="title">Stub</span> </span>{</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;HelloService&quot;</span>;</span><br><span class="line"></span><br><span class="line">HelloService() </span><br><span class="line">{</span><br><span class="line">    System.out.println(<span class="string">&quot;frameworks/base/services/java/com/android/server/HelloService.java HelloService()&quot;</span>);</span><br><span class="line">     init_native();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVal</span><span class="params">(<span class="keyword">int</span> val)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    System.out.println(<span class="string">&quot;frameworks/base/services/java/com/android/server/HelloService.java setVal()&quot;</span>);</span><br><span class="line">    setVal_native(val);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getVal</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    System.out.println(<span class="string">&quot;frameworks/base/services/java/com/android/server/HelloService.java getVal()&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> getVal_native();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">init_native</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">setVal_native</span><span class="params">(<span class="keyword">int</span> val)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">getVal_native</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>修改同目录的 <code>SystemServer.java</code> 文件</p>
<figure class="highlight java"><figcaption><span>SystemServer.java</span><a href="/downloads/code/hello-hard/SystemServer.java">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// initialization.</span></span><br><span class="line">        mActivityManagerService.systemReady(<span class="keyword">new</span> Runnable() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="comment">/////////////////添加的内容</span></span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    Slog.i(TAG, <span class="string">&quot;Hello Service&quot;</span>);</span><br><span class="line">                    ServiceManager.addService(<span class="string">&quot;hello&quot;</span>, <span class="keyword">new</span> HelloService());</span><br><span class="line">                } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">                    Slog.i(TAG, <span class="string">&quot;Failure starting Hello Service&quot;</span>, e);</span><br><span class="line">                }</span><br><span class="line"><span class="comment">/////////////////添加的内容到此为止</span></span><br><span class="line"></span><br><span class="line">                Slog.i(TAG, <span class="string">&quot;Making services ready&quot;</span>);</span><br><span class="line">                mSystemServiceManager.startBootPhase(</span><br><span class="line">                        SystemService.PHASE_ACTIVITY_MANAGER_READY);</span><br></pre></td></tr></table></figure>
<h3 id="开始编译并重新打包系统镜像-1"><a href="#开始编译并重新打包系统镜像-1" class="headerlink" title="开始编译并重新打包系统镜像"></a>开始编译并重新打包系统镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">回到源码根目录执行</span></span><br><span class="line">mmm frameworks/base/services</span><br><span class="line">make snod</span><br></pre></td></tr></table></figure>
<p> 这样，重新打包后的system.img系统镜像文件就在Application Frameworks层中包含了自定义的硬件服务HelloService，并且会在系统启动的时候，自动加载HelloService。这时，应用程序就可以通过Java接口来访问Hello硬件服务。</p>
<h2 id="内置Java应用程序测试Application-Frameworks层的硬件服务"><a href="#内置Java应用程序测试Application-Frameworks层的硬件服务" class="headerlink" title="内置Java应用程序测试Application Frameworks层的硬件服务"></a>内置Java应用程序测试Application Frameworks层的硬件服务</h2><p>原始教程是通过Android Studio创建工程项目的，这里笔者图了个方便直接在命令行中创建了。下面我们就可以开始创建我们第一个HelloAndroid工程了。在~/workandroid/external下建立helloandroid目录，进入helloandroid目录，执行下面命令（target 参数接的数字要与AOSP的版本对应）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/work/android/external</span><br><span class="line">mkdir helloandroid &amp;&amp; cd helloandroid</span><br><span class="line">android create project --name helloandroid --activity HelloAndroid --path ./ --package com.examples.helloandroid --target 1</span><br></pre></td></tr></table></figure>
<p>要修改的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">helloandroid&#x2F;src&#x2F;com&#x2F;examples&#x2F;helloandroid&#x2F;HelloAndroid.java </span><br><span class="line">helloandroid&#x2F;res&#x2F;layout&#x2F;main.xml </span><br><span class="line">helloandroid&#x2F;AndroidManifest.xml </span><br><span class="line">helloandroid&#x2F;Android.mk </span><br></pre></td></tr></table></figure>
<p>文件内容如下</p>
<figure class="highlight java"><figcaption><span>HelloAndroid.java</span><a href="/downloads/code/hello-app/HelloAndroid.java">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.examples.helloandroid;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.examples.helloandroid.R;</span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.ServiceManager;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.IHelloService;</span><br><span class="line"><span class="keyword">import</span> android.os.RemoteException;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.View.OnClickListener;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloAndroid</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">OnClickListener</span> </span>{</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String LOG_TAG = <span class="string">&quot;shy.luo.renju.Hello&quot;</span>;</span><br><span class="line">     </span><br><span class="line">    <span class="keyword">private</span> IHelloService helloService = <span class="keyword">null</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> EditText valueText = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Button readButton = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Button writeButton = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Button clearButton = <span class="keyword">null</span>;</span><br><span class="line">     </span><br><span class="line"> <span class="comment">/** Called when the activity is first created. */</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>{</span><br><span class="line"> <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"> setContentView(R.layout.main);</span><br><span class="line"> System.out.println(<span class="string">&quot;Hello Started&quot;</span>);</span><br><span class="line">    helloService = IHelloService.Stub.asInterface(</span><br><span class="line">        ServiceManager.getService(<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">  </span><br><span class="line"> valueText = (EditText)findViewById(R.id.edit_value);</span><br><span class="line"> readButton = (Button)findViewById(R.id.button_read);</span><br><span class="line"> writeButton = (Button)findViewById(R.id.button_write);</span><br><span class="line"> clearButton = (Button)findViewById(R.id.button_clear);</span><br><span class="line"> </span><br><span class="line">    readButton.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">    writeButton.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">    clearButton.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">  </span><br><span class="line"> Log.i(LOG_TAG, <span class="string">&quot;Hello Activity Created&quot;</span>);</span><br><span class="line"> }</span><br><span class="line">  </span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(v.equals(readButton)) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">int</span> val = helloService.getVal();</span><br><span class="line">            String text = String.valueOf(val);</span><br><span class="line">            valueText.setText(text);</span><br><span class="line">        } <span class="keyword">catch</span> (RemoteException e) {</span><br><span class="line">            Log.e(LOG_TAG, <span class="string">&quot;Remote Exception while reading value from device.&quot;</span>);</span><br><span class="line">        }       </span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(v.equals(writeButton)) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            String text = valueText.getText().toString();</span><br><span class="line">            <span class="keyword">int</span> val = Integer.parseInt(text);</span><br><span class="line">            helloService.setVal(val);</span><br><span class="line">        } <span class="keyword">catch</span> (RemoteException e) {</span><br><span class="line">            Log.e(LOG_TAG, <span class="string">&quot;Remote Exception while writing value to device.&quot;</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(v.equals(clearButton)) {</span><br><span class="line">        String text = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        valueText.setText(text);</span><br><span class="line">    }</span><br><span class="line"> }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><figcaption><span>main.xml</span><a href="/downloads/code/hello-app/main.xml">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;fill_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;fill_parent&quot;</span></span></span><br><span class="line"><span class="tag">    &gt;</span></span><br><span class="line">&lt;LinearLayout</span><br><span class="line"> android:layout_width=&quot;fill_parent&quot;</span><br><span class="line"> android:layout_height=&quot;wrap_content&quot;</span><br><span class="line"> android:orientation=&quot;vertical&quot;</span><br><span class="line"> android:gravity=&quot;center&quot;&gt;</span><br><span class="line"> <span class="tag">&lt;<span class="name">TextView</span> </span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:text</span>=<span class="string">&quot;@string/value&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">TextView</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">EditText</span> </span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_width</span>=<span class="string">&quot;fill_parent&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:id</span>=<span class="string">&quot;@+id/edit_value&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:hint</span>=<span class="string">&quot;@string/hint&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">EditText</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"> &lt;LinearLayout</span><br><span class="line"> android:layout_width=&quot;fill_parent&quot;</span><br><span class="line"> android:layout_height=&quot;wrap_content&quot;</span><br><span class="line"> android:orientation=&quot;horizontal&quot;</span><br><span class="line"> android:gravity=&quot;center&quot;&gt;</span><br><span class="line"> <span class="tag">&lt;<span class="name">Button</span> </span></span><br><span class="line"><span class="tag"> <span class="attr">android:id</span>=<span class="string">&quot;@+id/button_read&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:text</span>=<span class="string">&quot;@string/read&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Button</span> </span></span><br><span class="line"><span class="tag"> <span class="attr">android:id</span>=<span class="string">&quot;@+id/button_write&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:text</span>=<span class="string">&quot;@string/write&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">Button</span> </span></span><br><span class="line"><span class="tag"> <span class="attr">android:id</span>=<span class="string">&quot;@+id/button_clear&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:text</span>=<span class="string">&quot;@string/clear&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><figcaption><span>AndroidManifest.xml</span><a href="/downloads/code/hello-app/AndroidManifest.xml">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">package</span>=<span class="string">&quot;com.examples.helloandroid&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span> <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/ic_launcher&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;HelloAndroid&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight makefile"><figcaption><span>Android.mk</span><a href="/downloads/code/hello-app/Android.mk">view raw</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This Android.mk is empty, and &gt;&gt; does not build subdirectories &lt;&lt;.</span></span><br><span class="line"><span class="comment"># Individual packages in experimental/ must be built directly with &quot;mmm&quot;.</span></span><br><span class="line">LOCAL_PATH:= <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span></span><br><span class="line">LOCAL_MODULE_TAGS := optional</span><br><span class="line">LOCAL_SRC_FILES := <span class="variable">$(<span class="built_in">call</span> all-subdir-java-files)</span></span><br><span class="line">LOCAL_PACKAGE_NAME := Hello</span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_PACKAGE)</span></span><br></pre></td></tr></table></figure>
<h3 id="编译并运行模拟器进行验证"><a href="#编译并运行模拟器进行验证" class="headerlink" title="编译并运行模拟器进行验证"></a>编译并运行模拟器进行验证</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">回到源码根目录执行</span></span><br><span class="line">nicho@PC:~/work/android$ mmm packages/experimental/helloandroid</span><br><span class="line">make snod</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行安卓模拟器，指定编译好的文件</span></span><br><span class="line">emulator -show-kernel -avd helloandroid -kernel ../kernel/goldfish/arch/arm64/boot/Image -system ./out/target/product/generic_arm64/system.img -data ./out/target/product/generic_arm64/userdata.img -ramdisk ./out/target/product/generic_arm64/ramdisk.img</span><br></pre></td></tr></table></figure>
<p>至此，也就完整地学习了在Android的Linux内核空间添加硬件驱动程序、在Android的硬件抽象层添加硬件接口、在Android的Application Frameworks层提供硬件服务以及在Android的应用层调用硬件服务的整个过程。</p>
<hr>
<h2 id="参考内容"><a href="#参考内容" class="headerlink" title="参考内容"></a>参考内容</h2><p><a target="_blank" rel="noopener" href="https://www.linuxidc.com/Linux/2011-07/38979.htm">Android硬件抽象层（HAL）概要介绍和学习计划</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Free-Thinker/p/4142003.html">（三）在Ubuntu上为Android增加硬件抽象层（HAL）模块访问Linux内核驱动程序</a>  原始链接已经打不开了，重新找了一个</p>
<p>1.下载源码 </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/windcake/article/details/79349057">在Ubuntu16.04上下载并编译Android源代码</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a3bf09abb8fc">国内不翻墙下载Android 源代码</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36837858/article/details/107931549">Ubuntu下载编译android7.0源码教程从安装到编译</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u010164190/article/details/78332484">repo forall -c 用法</a></p>
<p>2.配置环境</p>
<p><del><a target="_blank" rel="noopener" href="https://www.wmzhe.com/soft-70404.html">下载jdk1.7</a></del></p>
<p><del><a target="_blank" rel="noopener" href="https://blog.csdn.net/pxmxx/article/details/79860421">配置jdk的环境变量</a></del></p>
<p><del><a target="_blank" rel="noopener" href="https://www.cnblogs.com/imoon22/p/13903327.html">用update-alternatives管理java版本</a></del></p>
<p><del><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/49dab66c1783">ubuntu安装和卸载jdk8</a></del></p>
<p><del><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_33160790/article/details/78252150">ubuntu16 安装openjdk java1.7</a></del></p>
<p><a target="_blank" rel="noopener" href="https://tieba.baidu.com/p/4515033977">最终是使用open jdk8 进行编译</a></p>
<p>重新添加了 <code>libwxgtk2.8-dev</code> 的ppa</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/chenxia1902/article/details/100716384">安装其他依赖</a></p>
<p>4.编译AOSP项目</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/lookinthefog/article/details/98677773">Android6.0源码编译</a></p>
<p>使用openjdk1.8 编译android7 到37%出现严重错误</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ 34% 16828/48845] Ensure Jack server is installed and started</span><br><span class="line">FAILED: /bin/bash -c &quot;(prebuilts/sdk/tools/jack-admin install-server prebuilts/sdk/tools/jack-launcher.jar prebuilts/sdk/tools/jack-server-4.8.ALPHA.jar  2&gt;&amp;1 || (exit 0) ) &amp;&amp; (JACK_SERVER_VM_ARGUMENTS=\&quot;-Dfile.encoding=UTF-8 -XX:+TieredCompilation\&quot; prebuilts/sdk/tools/jack-admin start-server 2&gt;&amp;1 || exit 0 ) &amp;&amp; (prebuilts/sdk/tools/jack-admin update server prebuilts/sdk/tools/jack-server-4.8.ALPHA.jar 4.8.ALPHA 2&gt;&amp;1 || exit 0 ) &amp;&amp; (prebuilts/sdk/tools/jack-admin update jack prebuilts/sdk/tools/jacks/jack-2.28.RELEASE.jar 2.28.RELEASE || exit 47; prebuilts/sdk/tools/jack-admin update jack prebuilts/sdk/tools/jacks/jack-3.36.CANDIDATE.jar 3.36.CANDIDATE || exit 47; prebuilts/sdk/tools/jack-admin update jack prebuilts/sdk/tools/jacks/jack-4.7.BETA.jar 4.7.BETA || exit 47 )&quot;</span><br><span class="line">Jack server already installed in &quot;/home/nicho/.jack-server&quot;</span><br><span class="line">Communication error with Jack server (35), try &#x27;jack-diagnose&#x27; or see Jack server log</span><br><span class="line">SSL error when connecting to the Jack server. Try &#x27;jack-diagnose&#x27;</span><br><span class="line">SSL error when connecting to the Jack server. Try &#x27;jack-diagnose&#x27;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[ 37% 18114/48845] target thumb C: lib...rnal/icu/icu4c/source/i18n/decNumber.c</span><br><span class="line">ninja: build stopped: subcommand failed.</span><br><span class="line">build/core/ninja.mk:148: recipe for target &#x27;ninja_wrapper&#x27; failed</span><br><span class="line">make: *** [ninja_wrapper] Error 1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">### make failed to build some targets (01:42:20 (hh:mm:ss)) ####</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zjy764219923/article/details/105612760">编译报错：build/core/ninja.mk:148: recipe for target ‘ninja_wrapper’ failed</a> </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/pcsxk/article/details/52594223">AOSP中make clean与make clobber的区别</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line"></span><br><span class="line">它会删除本次设置所生成的所有的output与中间文件。</span><br><span class="line">等价于指令</span><br><span class="line"></span><br><span class="line">rm -rf $OUT</span><br><span class="line"></span><br><span class="line">    1</span><br><span class="line"></span><br><span class="line">    这里的$OUT指的是out/target/product/[product_name]</span><br><span class="line"></span><br><span class="line">make clobber</span><br><span class="line"></span><br><span class="line">它会删除所有设置所生成的所有的output与中间文件。</span><br><span class="line">等价于指令</span><br><span class="line"></span><br><span class="line">rm -rf out/</span><br><span class="line"></span><br><span class="line">    1</span><br><span class="line"></span><br><span class="line">    可以看到，make clobber的严格在于它把整个out目录都删除了。</span><br></pre></td></tr></table></figure>
<p>5.下载编译安装 Android kernel</p>
<p><a target="_blank" rel="noopener" href="https://source.android.com/setup/build/building-kernels-deprecated">Building Kernels Manually-需要通过外网访问</a>这个文档比较全，在构建安卓系统的过程中可以全程使用</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/mandagod/article/details/47449335">Android源代码Linux Kernel下载及编译</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.drunkdream.com/2017/12/06/build-android-emulator-kernel/">编译可用的Android模拟器ranchu内核</a> </p>
<p>6.编写Linux 3.4.67的字符驱动</p>
<blockquote>
<p><strong>Learn How to Write a Driver for Linux 3.x With The Linux Driver Template</strong></p>
<p>A Linux Driver Template (LDT) has been published to help new Linux kernel developers writing hardware device drivers.</p>
<p>Constantine Shulyupin <a target="_blank" rel="noopener" href="https://lkml.org/lkml/2012/11/13/531">posted the Linux Driver Template</a> (LDT) on the Linux mailing list in order to merge it into the mainline  Linux kernel. The code can be used as as a starting point for new  drivers, and shows how to use several Linux facilities such as module,  platform driver, file operations (read/write, mmap, ioctl, blocking and  nonblocking mode, polling), kfifo, completion, interrupt, tasklet, work, kthread, timer, simple misc device,<br> multiple char devices, Device Model, configfs, UART, hardware loopback, software loopback and ftracer.</p>
<p>This sample has been added to other device drivers samples in <a target="_blank" rel="noopener" href="http://elinux.org/Device_drivers">eLinux.org</a>. And if you want to learn further there’s always the Linux driver bible: “<a target="_blank" rel="noopener" href="https://lwn.net/Kernel/LDD3/">Linux Device Drivers, Third Edition</a>” which can be downloaded for free as PDF, although it’s for 2.6.10 kernel and many parts may not be up-to date.</p>
<p>以上内容摘自: <a target="_blank" rel="noopener" href="https://www.cnx-software.com/2012/11/14/learn-how-to-write-a-driver-for-linux-3-x-with-the-linux-driver-template/">https://www.cnx-software.com/2012/11/14/learn-how-to-write-a-driver-for-linux-3-x-with-the-linux-driver-template/</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/y041039/archive/2013/05/22/3092774.html">Android 驱动之旅： 第一章  在Android 内核源代码工程中编写硬件驱动程序</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/y041039/archive/2013/05/22/3092868.html">Android 驱动之旅： 第二章 — 在Android 系统中增加C 可执行程序来访问硬件驱动程序</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/y041039/archive/2013/05/23/3094579.html">Android 驱动之旅： 第三章 硬件抽象层(HAL)增加接口模块访问硬件驱动程序</a> </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45932426/article/details/106194139">LOCAL_MODULE_PATH与LOCAL_MODULE_RELATIVE_PATH区别</a> </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zzf405788549/article/details/104610089">Android7.0 APP调用驱动流程 JNI层开发流程</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/luoshengyang/article/details/6575988">在Ubuntu为Android硬件抽象层（HAL）模块编写JNI方法提供Java访问硬件服务接口</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/240569">Android HAL(硬件抽象层)介绍以及调用</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/simaben/p/3446378.html">ubuntu下使用命令行创建一个android项目</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/bcsky/archive/2011/05/25/2056345.html">使用命令行方式开发Android应用</a> </p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/chen_yuyunfox/article/details/106112470">Android9.0 mm编译失败：ninja: error: ‘xxx’, needed by ‘xxx’, missing and no known rule to make it</a> </p>
<p><a target="_blank" rel="noopener" href="http://www.voidcn.com/article/p-vzxsaoko-brw.html">Android架构实例分析之编写hello驱动的系统硬件服务</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zjy764219923/article/details/106235420/">Android7关闭selinux（设置为Permissive模式）</a> </p>
<p>忽然意识到，驱动的编写模板应该在内核目录drivers里头去找。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cd ~/work/android &amp;&amp; source build/envsetup.sh &amp;&amp; lunch 2</span><br><span class="line"></span><br><span class="line">mmm packages/experimental/helloandroid/</span><br><span class="line"></span><br><span class="line">make snod</span><br><span class="line"></span><br><span class="line">emulator -show-kernel -avd helloandroid -kernel ../kernel/goldfish/arch/arm64/boot/Image -system ./out/target/product/generic_arm64/system.img -data ./out/target/product/generic_arm64/userdata.img -ramdisk ./out/target/product/generic_arm64/ramdisk.img</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">01-01 08:03:04.915   898   898 E ServiceManager: add_service(&#x27;hello&#x27;,6d) uid=1000 - PERMISSION DENIED</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">09-19 11:05:07.863  1866  1866 E AndroidRuntime: java.lang.NullPointerException: Attempt to invoke interface method &#x27;int android.os.IHelloService.getVal()&#x27; on a null object reference</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/eliot_shao/article/details/51770558">ServiceManager add_service SELinux Permission Denied</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.freesion.com/article/5898146080/">Android O 添加系统服务错误 add_service uid=1000 - PERMISSION DENIED</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> Android source code compile error: “Try increasing heap size with java option &#x27;-Xmx&lt;size&gt;&#x27;”</span><br><span class="line"></span><br><span class="line">export JACK_SERVER_VM_ARGUMENTS=&quot;-Dfile.encoding=UTF-8 -XX:+TieredCompilation -Xmx4g&quot;</span><br><span class="line"></span><br><span class="line">./prebuilts/sdk/tools/jack-admin kill-server</span><br><span class="line"></span><br><span class="line">./prebuilts/sdk/tools/jack-admin start-server</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/nwpushuai/article/details/78778602">repo介绍</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wa_ke/article/details/108010419">repo 撤销本地代码</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/jjw97_5/article/details/11608225">使用repo丢弃本地的改动</a></p>
<p><a target="_blank" rel="noopener" href="https://www.mobibrw.com/2016/3082">repo如何取消本地改动（How to discard changes using repo）</a></p>
<p>驱动的编写模板应该在内核目录drivers里头去找例子</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd ~/work/android &amp;&amp; source build/envsetup.sh &amp;&amp; lunch 2</span><br><span class="line">emulator -show-kernel -avd helloandroid -kernel ../kernel/goldfish/arch/arm64/boot/Image -system ./out/target/product/generic_arm64/system.img -data ./out/target/product/generic_arm64/userdata.img -ramdisk ./out/target/product/generic_arm64/ramdisk.img</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>9月15日下午编译SDK之后，安卓模拟器就总是卡在开机动画界面，9月18日早上打算重新走一遍教程，捋一捋问题出在了哪里。9月19日终于把整个流程都走完了，然后重头梳理教程，理清思路。</p>
<p>最初下载好源码后是使用了 <code>lunch 2</code> 去编译 <code>arm64</code> 架构，且能正常运行，但当走到 <code>adb devices</code> 这一步的时候发现 <code>device</code> 总是 <code>offline</code> ，所以后来又回过头去使用 <code>lunch 1</code> 编译了 <code>arm</code> 架构，这一次非常顺利，并且也能通过 <code>adb shell</code> 进入终端，不过到了最后一个步骤需要编写 <code>apk</code> 进行验证的时候需要编译 <code>SDK</code> ，结果编译完 <code>SDK</code> 之后忽然发现所有的模拟器（源码预编译好的与 <code>SDK</code> 中新编译出来的）都卡在启动界面无法进入，在网上参考了许多资料都没效果，后来实在想不出办法了，就 <code>make clean</code> 了以下，又重新使用 <code>lunch 2</code> 去编译 <code>arm64</code> 架构的，这一次全部都通了，然后在命令行启动 <code>android</code> 开启 <code>SDK manager</code> 下载与安卓源码匹配的工具与镜像。通过在命令行下创建安卓项目工程，编写好相关代码文件，编译生成安卓系统预置应用程序 <code>helloandroid</code> ，启动模拟器验证结果，这时候碰到了 <code>selinux</code> 的问题，在查阅了相关资料后修改 <code>system/core/init/init.cpp</code> 的一行代码，关闭安全选项，重新执行 <code>make -j8</code> 进行编译，开启模拟器验证成功，自此自下而上的了解安卓系统算是有了一点眉目。</p>
<p>在此非常感谢同学的帮助，也感谢所有在互联网上无私分享知识的网友们，没有你们的付出，我很难收获到这些知识，更不会有这篇记录的产生，谢谢你们。 </p>
<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script><link rel="stylesheet" href="/css/markmap.css" type="text/css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css"><script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>周国强
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://xsdjt.github.io/2021/09/11/ComputerScience/2021/09/android/" title="自下而上的了解Android">https://xsdjt.github.io/2021/09/11/ComputerScience/2021/09/android/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"><i class="fa fa-tag"></i> Android</a>
              <a href="/tags/linux/" rel="tag"><i class="fa fa-tag"></i> linux</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/08/27/life/2021/08/jujube/" rel="prev" title="门前的枣树">
      <i class="fa fa-chevron-left"></i> 门前的枣树
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/09/23/ComputerScience/2021/09/review/" rel="next" title="保存网络上的知识链接">
      保存网络上的知识链接 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%EF%BC%88%E5%9F%BA%E4%BA%8Eubuntu16-04%EF%BC%89"><span class="nav-number">2.</span> <span class="nav-text">环境准备（基于ubuntu16.04）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BDAndroid%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="nav-number">2.1.</span> <span class="nav-text">下载Android源代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91Android%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="nav-number">2.2.</span> <span class="nav-text">编译Android源代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85openjdk-1-8"><span class="nav-number">2.2.1.</span> <span class="nav-text">安装openjdk 1.8</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%BA%93"><span class="nav-number">2.2.2.</span> <span class="nav-text">安装依赖库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E8%AF%91AOSP%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="nav-number">2.2.3.</span> <span class="nav-text">编译AOSP项目的源代码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E3%80%81%E7%BC%96%E8%AF%91%E4%B8%8E%E5%AE%89%E8%A3%85android%E5%86%85%E6%A0%B8%E6%BA%90%E4%BB%A3%E7%A0%81-linux-kernel"><span class="nav-number">2.3.</span> <span class="nav-text">下载、编译与安装android内核源代码(linux kernel)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E5%86%99Linux%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="nav-number">3.</span> <span class="nav-text">编写Linux内核驱动程序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81"><span class="nav-number">3.1.</span> <span class="nav-text">编写代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#hello-h"><span class="nav-number">3.1.1.</span> <span class="nav-text">hello.h</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#hello-c"><span class="nav-number">3.1.2.</span> <span class="nav-text">hello.c</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#makefile"><span class="nav-number">3.1.3.</span> <span class="nav-text">makefile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Kconfig"><span class="nav-number">3.1.4.</span> <span class="nav-text">Kconfig</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E6%96%B0%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="nav-number">3.2.</span> <span class="nav-text">重新编译内核</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E5%86%99C%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%E6%B5%8B%E8%AF%95Linux%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="nav-number">4.</span> <span class="nav-text">编写C可执行程序测试Linux内核驱动程序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81-1"><span class="nav-number">4.1.</span> <span class="nav-text">编写代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#hello-c-1"><span class="nav-number">4.1.1.</span> <span class="nav-text">hello.c</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Android-mk"><span class="nav-number">4.1.2.</span> <span class="nav-text">Android.mk</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91hello%E7%A8%8B%E5%BA%8F"><span class="nav-number">4.2.</span> <span class="nav-text">编译hello程序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E7%A1%AC%E4%BB%B6%E6%8A%BD%E8%B1%A1%E5%B1%82%EF%BC%88HAL%EF%BC%89%E6%A8%A1%E5%9D%97%E8%AE%BF%E9%97%AELinux%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="nav-number">5.</span> <span class="nav-text">增加硬件抽象层（HAL）模块访问Linux内核驱动程序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-android-hardware-libhardware-include-hardware-%E7%9B%AE%E5%BD%95%E4%B8%AD%E5%88%9B%E5%BB%BA-hello-h-%E6%96%87%E4%BB%B6%E3%80%82"><span class="nav-number">5.1.</span> <span class="nav-text">在 android&#x2F;hardware&#x2F;libhardware&#x2F;include&#x2F;hardware 目录中创建 hello.h 文件。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8-android-hardware-libhardware-modules-hello-%E7%9B%AE%E5%BD%95%E4%B8%AD%E5%88%9B%E5%BB%BA-hello-c-%E5%92%8C-Android-mk-%E6%96%87%E4%BB%B6%E3%80%82"><span class="nav-number">5.2.</span> <span class="nav-text">在 android&#x2F;hardware&#x2F;libhardware&#x2F;modules&#x2F;hello 目录中创建 hello.c 和 Android.mk 文件。</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E5%86%99JNI-%E6%96%B9%E6%B3%95%E5%9C%A8%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%A1%86%E6%9E%B6%E5%B1%82%E6%8F%90%E4%BE%9BJava-%E6%8E%A5%E5%8F%A3%E8%AE%BF%E9%97%AE%E7%A1%AC%E4%BB%B6"><span class="nav-number">6.</span> <span class="nav-text">编写JNI 方法在应用程序框架层提供Java 接口访问硬件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E5%85%A5-android-frameworks-base-services-core-jni-%E7%9B%AE%E5%BD%95%E5%88%9B%E5%BB%BA-com-android-server-HelloService-cpp-%E6%96%87%E4%BB%B6"><span class="nav-number">6.1.</span> <span class="nav-text">进入 android&#x2F;frameworks&#x2F;base&#x2F;services&#x2F;core&#x2F;jni 目录创建 com_android_server_HelloService.cpp 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B%E7%BC%96%E8%AF%91%E5%B9%B6%E9%87%8D%E6%96%B0%E6%89%93%E5%8C%85%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F"><span class="nav-number">6.2.</span> <span class="nav-text">开始编译并重新打包系统镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9C%A8%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%A1%86%E6%9E%B6%E5%B1%82%E5%A2%9E%E5%8A%A0%E7%A1%AC%E4%BB%B6%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%8F%A3"><span class="nav-number">7.</span> <span class="nav-text">在应用程序框架层增加硬件服务接口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A6%96%E5%85%88%E5%AE%9A%E4%B9%89%E9%80%9A%E4%BF%A1%E6%8E%A5%E5%8F%A3"><span class="nav-number">7.1.</span> <span class="nav-text">首先定义通信接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91IHelloService-aidl%E6%8E%A5%E5%8F%A3"><span class="nav-number">7.2.</span> <span class="nav-text">编译IHelloService.aidl接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B%E7%BC%96%E8%AF%91%E5%B9%B6%E9%87%8D%E6%96%B0%E6%89%93%E5%8C%85%E7%B3%BB%E7%BB%9F%E9%95%9C%E5%83%8F-1"><span class="nav-number">7.3.</span> <span class="nav-text">开始编译并重新打包系统镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%85%E7%BD%AEJava%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%B5%8B%E8%AF%95Application-Frameworks%E5%B1%82%E7%9A%84%E7%A1%AC%E4%BB%B6%E6%9C%8D%E5%8A%A1"><span class="nav-number">8.</span> <span class="nav-text">内置Java应用程序测试Application Frameworks层的硬件服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C%E6%A8%A1%E6%8B%9F%E5%99%A8%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81"><span class="nav-number">8.1.</span> <span class="nav-text">编译并运行模拟器进行验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E5%86%85%E5%AE%B9"><span class="nav-number">9.</span> <span class="nav-text">参考内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">10.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="周国强"
      src="/images/uparrow.jpg">
  <p class="site-author-name" itemprop="name">周国强</p>
  <div class="site-description" itemprop="description">勤学勤思出真知</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xsdjt" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xsdjt" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:zhouguoqiang2015@outlook.com" title="E-Mail → mailto:zhouguoqiang2015@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">周国强</span>
</div>

<!--添加运行时间-->
<span id="sitetime"></span>
<script language=javascript>
	function siteTime(){
		window.setTimeout("siteTime()", 1000);
		var seconds = 1000;
		var minutes = seconds * 60;
		var hours = minutes * 60;
		var days = hours * 24;
		var years = days * 365;
		var today = new Date();
		var todayYear = today.getFullYear();
		var todayMonth = today.getMonth()+1;
		var todayDate = today.getDate();
		var todayHour = today.getHours();
		var todayMinute = today.getMinutes();
		var todaySecond = today.getSeconds();
		/* 
      Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
      year - 作为date对象的年份，为4位年份值
      month - 0-11之间的整数，做为date对象的月份
      day - 1-31之间的整数，做为date对象的天数
      hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
      minutes - 0-59之间的整数，做为date对象的分钟数
      seconds - 0-59之间的整数，做为date对象的秒数
      microseconds - 0-999之间的整数，做为date对象的毫秒数
     */
		var t1 = Date.UTC(2021,04,27,18,12,20); //北京时间2021-04-27 18:12:20
		var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
		var diff = t2-t1;
		var diffYears = Math.floor(diff/years);
		var diffDays = Math.floor((diff/days)-diffYears*365);
		var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
		var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
		var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
		if(0 == diffYears)
		    document.getElementById("sitetime").innerHTML="已运行"+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
                else
		    document.getElementById("sitetime").innerHTML="已运行"+diffYears+" 年 "+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
	}
	siteTime();
</script>
<!--// 添加运行时间-->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '68d16df1433acc6c052d',
      clientSecret: '60478ee823859ddf4cdae47186eec88cbb5c9fc4',
      repo        : 'xsdjt.github.io',
      owner       : 'xsdjt',
      admin       : ['xsdjt'],
      id          : 'a427ff7a3fa66fd98eea80245dbe2ad5',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

<!-- hexo injector body_end start -->
  <script src="https://cdn.jsdelivr.net/npm/d3@6"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-view"></script>
  <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.11.6/dist/browser/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-base64@3.6.1/base64.min.js"></script>
  <script>
      // console.log(window.markmap);
      const { Markmap, loadCSS, loadJS, loadPlugins } = window.markmap;
      let Transformer = window.markmap.Transformer;
      let transformer = new Transformer();

      const mindmaps = document.querySelectorAll('.markmap-svg');
      
      for(const mindmap of mindmaps) {

          //console.log(mindmap.innerHTML);
          //let a=new Buffer(mindmap.innerHTML,'base64').toString(); //base64 decode

          let mddata = Base64.decode(mindmap.innerHTML);
          // console.log(mddata);

          const { root, features } = transformer.transform(mddata);


          // 1. load assets
          const { styles, scripts } = transformer.getAssets();
          if (styles) loadCSS(styles);
          // if (scripts) loadJS(scripts);
          if (scripts) loadJS(scripts, { getMarkmap: () => window.markmap });


          Markmap.create(mindmap, null, root);
      }
  </script> <!-- hexo injector body_end end --></body>
</html>
